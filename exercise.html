<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i t·∫≠p t·ª´ v·ª±ng</title>
    <!-- Nh√∫ng Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loader animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Container ch√≠nh -->
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden relative">

        <!-- Header -->
        <div class="bg-blue-600 p-6 text-white text-center relative">
            <a id="backLink" href="index.html"
               class="absolute left-4 top-1/2 -translate-y-1/2 flex items-center gap-1 text-blue-200 hover:text-white text-xs font-medium transition"
               title="V·ªÅ danh s√°ch unit">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                M·ª•c l·ª•c
            </a>
            <h1 id="quiz-header-title" class="text-2xl font-bold mb-2">B√†i t·∫≠p</h1>
            <p id="quiz-header-subtitle" class="text-blue-100 text-sm">Luy·ªán t·∫≠p t·ª´ v·ª±ng v√† c·∫•u tr√∫c c√¢u</p>
        </div>

        <!-- M√†n h√¨nh Loading -->
        <div id="loading-screen" class="p-12 text-center">
            <div class="loader mb-4"></div>
            <p class="text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu b√†i t·∫≠p...</p>
        </div>

        <!-- M√†n h√¨nh L·ªói (n·∫øu c√≥) -->
        <div id="error-screen" class="hidden p-12 text-center">
            <div class="text-red-500 mb-4">
                <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">L·ªói t·∫£i d·ªØ li·ªáu</h2>
            <p id="error-message" class="text-gray-500 mb-6">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu b√†i t·∫≠p. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
            <button onclick="location.reload()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">Th·ª≠
                l·∫°i</button>
        </div>

        <!-- M√†n h√¨nh Quiz -->
        <div id="quiz-screen" class="hidden p-6 md:p-8">
            <!-- Progress Bar -->
            <div class="flex justify-between text-sm text-gray-500 mb-2">
                <span id="progress-text">C√¢u 1 / 0</span>
                <span id="score-text">ƒêi·ªÉm: 0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300"
                    style="width: 0%"></div>
            </div>

            <!-- C√¢u h·ªèi -->
            <div class="text-center mb-8 fade-in flex flex-col items-center">
                <!-- Icon Loa cho ph·∫ßn phi√™n √¢m -->
                <button id="speak-btn"
                    class="hidden items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 hover:scale-110 transition-transform mb-3 focus:outline-none"
                    title="Nghe ph√°t √¢m">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>

                <div class="inline-block bg-blue-50 text-blue-800 px-4 py-1 rounded-full text-sm font-semibold mb-4 min-w-[50px] min-h-[28px] empty:hidden"
                    id="ipa-text"></div>
                <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2 leading-tight" id="question-word">word</h2>
                <p id="question-desc" class="text-gray-400 text-sm italic mt-2">Nghƒ©a c·ªßa t·ª´ l√† g√¨?</p>
            </div>

            <!-- C√°c l·ª±a ch·ªçn -->
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Buttons s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS t·∫°i ƒë√¢y -->
            </div>

            <!-- Th√¥ng b√°o k·∫øt qu·∫£ v√† n√∫t ti·∫øp theo -->
            <div id="feedback-area" class="hidden text-center mt-4">
                <div id="feedback-message-container" class="mb-4">
                    <p id="feedback-message" class="text-lg font-bold"></p>
                    <p id="feedback-explanation" class="text-sm text-gray-600 mt-2 hidden"></p>
                </div>
                <button id="next-btn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition transform hover:scale-105 shadow-md">
                    C√¢u ti·∫øp theo
                </button>
            </div>
        </div>

        <!-- M√†n h√¨nh K·∫øt qu·∫£ (·∫®n m·∫∑c ƒë·ªãnh) -->
        <div id="result-screen" class="hidden p-8 text-center">
            <div class="mb-6">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
                    <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-gray-800">Ho√†n th√†nh!</h2>
                <p class="text-gray-600 mt-2">B·∫°n ƒë√£ ho√†n th√†nh b√†i t·∫≠p.</p>
            </div>

            <div class="bg-gray-50 rounded-xl p-6 mb-8">
                <p class="text-gray-500 text-sm uppercase tracking-wide">ƒêi·ªÉm s·ªë c·ªßa b·∫°n</p>
                <p class="text-5xl font-bold text-blue-600 mt-2" id="final-score">0</p>
                <p class="text-gray-400 mt-1" id="total-questions">/ 0</p>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="location.reload()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition">
                    L√†m l·∫°i b√†i t·∫≠p
                </button>
                <a id="backLinkResult" href="index.html"
                    class="w-full block text-center bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-8 rounded-lg transition">
                    V·ªÅ trang m·ª•c l·ª•c
                </a>
            </div>
        </div>

    </div>

    <script>
        // ƒê·ªçc file JSON t·ª´ tham s·ªë URL ?file=
        function getDataFile() {
            const params = new URLSearchParams(window.location.search);
            const file = params.get('file');
            if (!file) return null;
            // Cho ph√©p d·∫•u / ƒë·ªÉ h·ªó tr·ª£ subfolder (book_01/unit_001.json)
            // NgƒÉn path traversal b·∫±ng c√°ch lo·∫°i b·ªè ".." v√† k√Ω t·ª± nguy hi·ªÉm
            const safeName = file
                .replace(/\.\./g, '')
                .replace(/[^a-zA-Z0-9_\-\.\/]/g, '');
            return `data/${safeName}`;
        }

        // ƒê·ªçc tham s·ªë ?book= ƒë·ªÉ t·∫°o back link
        function getBookParam() {
            return new URLSearchParams(window.location.search).get('book');
        }

        let quizData = [];
        let vocabDataForWrongAnswers = [];

        // Tr·∫°ng th√°i ·ª©ng d·ª•ng
        let currentQuestionIndex = 0;
        let score = 0;
        let shuffledQuestions = [];

        // C√°c ph·∫ßn t·ª≠ DOM
        const loadingScreen = document.getElementById('loading-screen');
        const errorScreen = document.getElementById('error-screen');
        const errorMessage = document.getElementById('error-message');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        const questionWordEl = document.getElementById('question-word');
        const ipaTextEl = document.getElementById('ipa-text');
        const speakBtn = document.getElementById('speak-btn');
        const questionDescEl = document.getElementById('question-desc');
        const optionsContainer = document.getElementById('options-container');
        const feedbackArea = document.getElementById('feedback-area');
        const feedbackMessage = document.getElementById('feedback-message');
        const feedbackExplanation = document.getElementById('feedback-explanation');
        const nextBtn = document.getElementById('next-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const scoreText = document.getElementById('score-text');
        const finalScoreEl = document.getElementById('final-score');
        const totalQuestionsEl = document.getElementById('total-questions');

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // T·∫£i d·ªØ li·ªáu t·ª´ m·ªôt file JSON ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh qua URL
        async function loadData() {
            const dataFile = getDataFile();

            if (!dataFile) {
                // Kh√¥ng c√≥ tham s·ªë file ‚Üí quay v·ªÅ trang ch·ªß
                window.location.replace('index.html');
                return;
            }

            try {
                const response = await fetch(dataFile);
                if (!response.ok) {
                    throw new Error(`Kh√¥ng t√¨m th·∫•y file: ${dataFile} (HTTP ${response.status})`);
                }
                const data = await response.json();

                // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ trang
                if (data.title) {
                    document.querySelector('#quiz-header-title').textContent = data.title;
                    document.title = `B√†i t·∫≠p ‚Äì ${data.title}`;
                }
                if (data.unit) {
                    document.querySelector('#quiz-header-subtitle').textContent =
                        `Unit ${data.unit} ¬∑ Luy·ªán t·∫≠p t·ª´ v·ª±ng v√† c·∫•u tr√∫c c√¢u`;
                }

                const allVocab = (data.vocabulary || []).map(v => ({ ...v, type: 'vocab' }));
                const allExercises = (data.exercises || []).map(e => ({ ...e, type: 'sentence' }));

                if (allVocab.length === 0 && allExercises.length === 0) {
                    throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu b√†i t·∫≠p n√†o ƒë∆∞·ª£c t√¨m th·∫•y.');
                }

                vocabDataForWrongAnswers = allVocab;
                quizData = [...allVocab, ...allExercises];

                initQuiz();

                // C·∫≠p nh·∫≠t back links d·ª±a tr√™n ?book=
                const bookParam = getBookParam();
                const backHref = bookParam
                    ? `index.html?book=${encodeURIComponent(bookParam)}`
                    : 'index.html';
                document.getElementById('backLink').href = backHref;
                document.getElementById('backLinkResult').href = backHref;

                loadingScreen.classList.add('hidden');
                quizScreen.classList.remove('hidden');

            } catch (error) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
                loadingScreen.classList.add('hidden');
                errorScreen.classList.remove('hidden');
                errorMessage.textContent = error.message;
            }
        }

        // Kh·ªüi t·∫°o b√†i quiz
        function initQuiz() {
            shuffledQuestions = shuffleArray([...quizData]);
            loadQuestion();
        }

        // H√†m ph√°t √¢m thanh b·∫±ng Web Speech API (kh√¥ng c·∫ßn request m·∫°ng)
        function speakText(text, rate = 0.9) {
            if (!text || !window.speechSynthesis) return;
            // X√≥a d·∫•u g·∫°ch ch√¢n (ch·ªó tr·ªëng b√†i t·∫≠p) tr∆∞·ªõc khi ƒë·ªçc
            const cleaned = text.replace(/_+/g, '').replace(/\s{2,}/g, ' ').trim();
            window.speechSynthesis.cancel();
            const utter = new SpeechSynthesisUtterance(cleaned);
            utter.lang = 'en-US';
            utter.rate = rate;
            window.speechSynthesis.speak(utter);
        }

        // T·∫£i c√¢u h·ªèi
        function loadQuestion() {
            // Reset giao di·ªán
            feedbackArea.classList.add('hidden');
            feedbackExplanation.classList.add('hidden');
            optionsContainer.innerHTML = '';

            const currentData = shuffledQuestions[currentQuestionIndex];

            // C·∫≠p nh·∫≠t Progress bar
            const progress = ((currentQuestionIndex) / shuffledQuestions.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `C√¢u ${currentQuestionIndex + 1} / ${shuffledQuestions.length}`;
            scoreText.textContent = `ƒêi·ªÉm: ${score}`;

            let correctAnswer;
            let allAnswers;

            // X·ª≠ l√Ω s·ª± ki·ªán n√∫t loa
            speakBtn.onclick = null;

            if (currentData.type === "vocab") {
                questionWordEl.textContent = currentData.word;
                ipaTextEl.textContent = currentData.ipa || '';
                ipaTextEl.style.display = currentData.ipa ? 'inline-block' : 'none';
                questionDescEl.textContent = "Nghƒ©a c·ªßa t·ª´ l√† g√¨?";

                // Hi·ªÉn th·ªã n√∫t loa cho t·ª´ v·ª±ng
                speakBtn.style.display = 'inline-flex';
                speakBtn.onclick = () => speakText(currentData.word);

                correctAnswer = currentData.meaning;

                // Tr√≠ch xu·∫•t danh s√°ch c√°c nghƒ©a sai t·ª´ kho t·ª´ v·ª±ng
                let wrongAnswers = vocabDataForWrongAnswers
                    .filter(item => item.meaning !== correctAnswer)
                    .map(item => item.meaning);

                wrongAnswers = shuffleArray(wrongAnswers).slice(0, 3);
                allAnswers = shuffleArray([correctAnswer, ...wrongAnswers]);

            } else {
                questionWordEl.textContent = currentData.question;
                ipaTextEl.style.display = 'none';
                speakBtn.style.display = 'inline-flex';
                speakBtn.onclick = () => speakText(currentData.question, 0.7);
                questionDescEl.textContent = "Ch·ªçn ƒë√°p √°n ƒë√∫ng ƒëi·ªÅn v√†o ch·ªó tr·ªëng / Ch·ªçn c√¢u ƒë√∫ng";

                correctAnswer = currentData.answer;
                allAnswers = shuffleArray([...currentData.options]);
            }

            // Render buttons
            allAnswers.forEach(answer => {
                const button = document.createElement('button');
                button.className = "w-full bg-white border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 text-gray-700 font-semibold py-4 px-4 rounded-xl transition duration-200 text-left flex items-center group";
                button.innerHTML = `
                    <span class="w-8 h-8 rounded-full flex-shrink-0 bg-gray-100 text-gray-500 flex items-center justify-center mr-3 text-sm group-hover:bg-blue-200 group-hover:text-blue-700 transition">?</span>
                    <span class="text-left">${answer}</span>
                `;
                button.onclick = () => checkAnswer(button, answer, correctAnswer, currentData);
                optionsContainer.appendChild(button);
            });
        }

        // Ki·ªÉm tra ƒë√°p √°n
        function checkAnswer(selectedBtn, selectedAnswer, correctAnswer, currentData) {
            // V√¥ hi·ªáu h√≥a t·∫•t c·∫£ n√∫t
            const buttons = optionsContainer.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);

            const isCorrect = selectedAnswer === correctAnswer;

            // Hi·ªÉn th·ªã gi·∫£i th√≠ch n·∫øu c√≥ (cho vocab)
            if (currentData.type === "vocab" && currentData.example) {
                feedbackExplanation.innerHTML = `<strong>V√≠ d·ª•:</strong> ${currentData.example}<br><span class="text-gray-500 italic">${currentData.exampleMeaning}</span>`;
                feedbackExplanation.classList.remove('hidden');
            } else {
                feedbackExplanation.classList.add('hidden');
            }

            if (isCorrect) {
                selectedBtn.classList.remove('border-gray-200', 'hover:border-blue-500', 'hover:bg-blue-50');
                selectedBtn.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                const iconSpan = selectedBtn.querySelector('span:first-child');
                iconSpan.textContent = '‚úì';
                iconSpan.classList.remove('bg-gray-100', 'text-gray-500', 'group-hover:bg-blue-200', 'group-hover:text-blue-700');
                iconSpan.classList.add('bg-green-500', 'text-white');

                score++;
                feedbackMessage.textContent = "Ch√≠nh x√°c! üéâ";
                feedbackMessage.className = "text-lg font-bold text-green-600";
            } else {
                selectedBtn.classList.remove('border-gray-200', 'hover:border-blue-500', 'hover:bg-blue-50');
                selectedBtn.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                const iconSpan = selectedBtn.querySelector('span:first-child');
                iconSpan.textContent = '‚úï';
                iconSpan.classList.remove('bg-gray-100', 'text-gray-500', 'group-hover:bg-blue-200', 'group-hover:text-blue-700');
                iconSpan.classList.add('bg-red-500', 'text-white');

                // Highlight ƒë√°p √°n ƒë√∫ng
                buttons.forEach(btn => {
                    const answerText = btn.querySelector('span:last-child').textContent;
                    if (answerText === correctAnswer) {
                        btn.classList.remove('border-gray-200');
                        btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                        const correctIconSpan = btn.querySelector('span:first-child');
                        correctIconSpan.textContent = '‚úì';
                        correctIconSpan.classList.remove('bg-gray-100', 'text-gray-500');
                        correctIconSpan.classList.add('bg-green-500', 'text-white');
                    }
                });

                feedbackMessage.textContent = `Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√†: ${correctAnswer}`;
                feedbackMessage.className = "text-lg font-bold text-red-600";
            }

            scoreText.textContent = `ƒêi·ªÉm: ${score}`;
            feedbackArea.classList.remove('hidden');
            feedbackArea.classList.add('fade-in');
        }

        // Chuy·ªÉn c√¢u ti·∫øp theo
        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < shuffledQuestions.length) {
                loadQuestion();
            } else {
                showResults();
            }
        });

        // Hi·ªÉn th·ªã k·∫øt qu·∫£ cu·ªëi c√πng
        function showResults() {
            quizScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            resultScreen.classList.add('fade-in');

            finalScoreEl.textContent = score;
            totalQuestionsEl.textContent = `/ ${shuffledQuestions.length}`;
        }

        // B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu khi trang v·ª´a m·ªü
        document.addEventListener('DOMContentLoaded', loadData);

    </script>
</body>

</html>